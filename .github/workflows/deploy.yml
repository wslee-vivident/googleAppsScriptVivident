name: Deploy to Google Apps Script

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Clasp
        run: npm install -g @google/clasp

      # 4. (ìˆ˜ì •ë¨) Node.jsë¥¼ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•˜ê²Œ íŒŒì¼ ìƒì„± (ë”°ì˜´í‘œ/íŠ¹ìˆ˜ë¬¸ì ê¹¨ì§ ë°©ì§€)
      - name: Create .clasprc.json
        env:
          CLASPRC_SECRET: ${{ secrets.CLASPRC_JSON }}
        run: |
          node -e "const fs = require('fs'); const os = require('os'); const path = path.join(os.homedir(), '.clasprc.json'); fs.writeFileSync(path, process.env.CLASPRC_SECRET);"
          
          # íŒŒì¼ì´ ì˜ ë§Œë“¤ì–´ì¡ŒëŠ”ì§€ í™•ì¸
          if [ -s ~/.clasprc.json ]; then
            echo "âœ… íŒŒì¼ ìƒì„± ì„±ê³µ (í¬ê¸°: $(wc -c < ~/.clasprc.json) bytes)"
          else
            echo "âŒ íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
            exit 1
          fi

      # ğŸ‘‡ [ìˆ˜ì •ë¨] ë””ë²„ê¹… ì •ë³´ë¥¼ ì¶œë ¥í•˜ê³  ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë©ˆì¶”ì§€ ì•Šê³  ì›ì¸ì„ ë³´ì—¬ì¤Œ
      - name: Push all projects
        run: |
          echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬ íŒŒì¼ ëª©ë¡ í™•ì¸:"
          ls -la
          
          echo "ğŸš€ í•˜ìœ„ í´ë” íƒìƒ‰ ì‹œì‘..."
          
          # í•˜ìœ„ ë””ë ‰í† ë¦¬ë¥¼ ìˆœíšŒ
          for dir in */; do
            # ë””ë ‰í† ë¦¬ ì´ë¦„ì—ì„œ ëì˜ / ì œê±° (ex: project/ -> project)
            dirname=${dir%/}
            
            echo "-----------------------------------"
            echo "ğŸ” Checking folder: $dirname"
            
            if [ -f "$dirname/.clasp.json" ]; then
              echo "âœ… .clasp.json ë°œê²¬! ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."
              
              cd "$dirname"
              
              # ì‹¤ì œ ë°°í¬ ëª…ë ¹ (ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥)
              clasp push --force || { echo "âŒ $dirname ë°°í¬ ì‹¤íŒ¨!"; exit 1; }
              
              cd ..
            else
              echo "âš ï¸ $dirname í´ë”ì— .clasp.jsonì´ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í‚µí•©ë‹ˆë‹¤."
            fi
          done
        shell: bash